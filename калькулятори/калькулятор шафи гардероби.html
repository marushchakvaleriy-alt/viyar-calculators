<html lang="uk">
<head>
<meta charset="utf-8"/>
<title>Калькулятор поінтів — Viyar</title>
<style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f3f4f6;
      font-size: 14px;
    }
    .wrapper {
      max-width: 1100px;
      margin: 20px auto;
      background: white;
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    header {
      padding: 10px 0;
      position: relative;
      background: white;
    }
    .title-small { 
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 4px;
    }
    .header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    header img { height: 32px; }
    header label { margin-left: 6px; font-size: 13px; }
    input, select {
      font-size: 14px;
      padding: 6px 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37,99,235,0.2);
    }
    header input { width: 110px; }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    button:hover { background: #1d4ed8; }
    #addFacadeTypeBtn:hover { 
      background: #1d4ed8; 
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }
    .settings-btn {
      position: absolute;
      top: 0;
      right: 8px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #374151;
    }
    .settings-btn:hover { color: #111827; }
    .section { margin: 20px 0; }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: start;
    }
    .facade-list label {
      display: block;
      margin: 8px 0 4px;
    }
    .hidden { display: none; }
    /* Модальне вікно - сучасний дизайн (як у кухнях) */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 0;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      animation: slideUp 0.3s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: left;
    }
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .modal-header h3 { margin: 0; font-size: 16px; font-weight: 600; color: white; }
    .modal-actions { padding: 15px 20px; display: flex; gap: 12px; justify-content: flex-end; background: #f8fafc; }
    .modal-actions button { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    .modal-actions button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .modal-content h3 {
      margin-top: 0;
      font-size: 18px;
      color: white;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .modal-content button {
      margin-top: 15px;
    }
  
    .settings-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.35); z-index: 9999; }
    .settings-content { position: relative; background:#fff; padding:16px 20px; border-radius:12px; max-width:720px; width:95%; max-height:80vh; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    .settings-close { position:absolute; top:10px; right:12px; border:none; background:transparent; font-size:20px; line-height:1; cursor:pointer; color:#6b7280; }
    .settings-close:hover { color:#111827; }
  
    .header-bar { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .points-hud { display:inline-block; padding:8px 14px; border-radius:999px; background:#eef2ff; color:#1d4ed8; font-weight:700; border:1px solid #c7d2fe; font-size:16px; }
    @media (max-width:640px){ .points-hud { font-size:12px; padding:4px 8px; } }
    
    /* Кнопка повернення */
    .back-button {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1000;
      background: #1976d2;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      text-decoration: none;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .back-button:hover {
      background: #1565c0;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
      text-decoration: none;
      color: white;
    }

    @media (max-width: 768px) {
      .back-button {
        top: 10px;
        left: 10px;
        width: 35px;
        height: 35px;
        font-size: 16px;
      }
    }
    
    /* Підказки */
    .tooltip-container {
      position: relative;
      display: inline-block;
      margin-left: 5px;
    }
    .tooltip-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: #6b7280;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      font-weight: bold;
      cursor: help;
      vertical-align: middle;
    }
    .tooltip-icon:hover {
      background: #374151;
    }
    .tooltip-content {
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.4;
      white-space: nowrap;
      max-width: 300px;
      white-space: normal;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .tooltip-content::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #1f2937;
    }
    .tooltip-container:hover .tooltip-content {
      opacity: 1;
      visibility: visible;
    }
    
    /* Поле пароля */
    .password-field {
      display: none;
      margin: 10px 0;
      padding: 10px;
      background: #f9fafb;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }
    .password-field input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      margin-right: 10px;
      width: 200px;
    }
    .password-field button {
      padding: 8px 16px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .password-field button:hover {
      background: #1d4ed8;
    }
    .password-error {
      color: #dc2626;
      font-size: 12px;
      margin-top: 5px;
    }
    
    /* Стилі для друку - оптимізовано для А4 */
    @media print {
      @page {
        size: A4;
        margin: 0.5cm 0.5cm 0.5cm 0.5cm;
      }
      
      .no-print,
      .header-bar,
      .password-field,
      .calc-actions,
      .modal,
      .password-modal,
      .settings-modal,
      button,
      .remove-btn,
      input[type="button"],
      .close,
      #pointsDisplay {
        display: none !important;
      }
      
      /* Приховуємо всі кнопки додавання */
      button[onclick*="showAdd"],
      button[onclick*="Додати"],
      button[onclick*="add"],
      .settings-btn {
        display: none !important;
      }
      
      /* Показуємо поінти при друку */
      .points-hud {
        display: inline-block !important;
        background: #f0f0f0 !important;
        border: 1px solid #ccc !important;
        padding: 3px 6px !important;
        margin: 5px 0 !important;
        font-weight: bold !important;
        font-size: 12px !important;
      }
      
      * {
        box-sizing: border-box;
      }
      
      /* Збільшуємо поля з матеріалами для друку */
      .element-item,
      .element-item label {
        font-size: 12px !important;
        line-height: 1.4 !important;
        padding: 5px !important;
        margin-bottom: 3px !important;
        white-space: nowrap !important;
        overflow: visible !important;
        text-overflow: clip !important;
        width: 100% !important;
        display: block !important;
      }
      
      /* Збільшуємо ширину контейнерів з матеріалами */
      #facadeMaterialsList,
      #facadeTypesList,
      #additionalElementsList,
      #handlesList,
      #lightingList,
      #appliancesList {
        width: 100% !important;
        max-width: none !important;
        overflow: visible !important;
      }
      
      /* Забезпечуємо, що довгі назви займають всю ширину */
      .element-item {
        width: 100% !important;
        min-width: 0 !important;
        overflow: visible !important;
        word-break: keep-all !important;
        hyphens: none !important;
      }
      
      /* Спеціально для лейблів з довгими назвами */
      .element-item label {
        max-width: none !important;
        width: auto !important;
        display: inline !important;
        overflow: visible !important;
      }
      
      /* Покращуємо відображення результату при друку */
      #pointsResult {
        font-size: 16px !important;
        font-weight: bold !important;
        border: 2px solid #000 !important;
        padding: 10px !important;
        margin: 10px 0 !important;
        background: #f5f5f5 !important;
        page-break-after: avoid !important;
      }
      
      /* Покращуємо заголовки розділів */
      .section h3 {
        font-size: 14px !important;
        font-weight: bold !important;
        margin-top: 15px !important;
        margin-bottom: 8px !important;
        page-break-after: avoid !important;
      }
      
      /* Покращуємо відображення полів вводу */
      input, select {
        border: 1px solid #000 !important;
        background: white !important;
        font-size: 11px !important;
        padding: 2px 4px !important;
      }
      
      body {
        font-size: 10px !important;
        line-height: 1.2 !important;
        margin: 0 !important;
        width: 100% !important;
      }
      
      /* Забезпечуємо максимальну ширину для всіх контейнерів */
      .container, .wrapper, .main-content, .section {
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
        padding: 5px !important;
      }
      
      /* Забезпечуємо, що селекти та поля не обмежують ширину */
      select, input {
        max-width: none !important;
        width: auto !important;
        padding: 0 !important;
        color: #000 !important;
        background: white !important;
      }
      
      .wrapper {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        max-width: none !important;
      }
      
      header {
        margin: 0 0 5px 0 !important;
        padding: 0 !important;
        page-break-after: avoid;
      }
      
      .container {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
      }
      
      .section {
        margin: 0 0 5px 0 !important;
        padding: 0 !important;
        page-break-inside: avoid;
        break-inside: avoid;
        orphans: 1;
        widows: 1;
      }
      
      h3 {
        font-size: 11px !important;
        margin: 3px 0 2px 0 !important;
        color: #000 !important;
        page-break-after: avoid;
        font-weight: bold !important;
      }
      
      label {
        font-size: 9px !important;
        margin: 0 0 1px 0 !important;
        display: inline-block !important;
        width: auto !important;
      }
      
      input, select {
        font-size: 9px !important;
        padding: 1px 2px !important;
        margin: 0 0 1px 0 !important;
        border: 1px solid #ccc !important;
        width: 60px !important;
        height: 16px !important;
      }
      
      /* Компактний макет для полів */
      .section > div {
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* Групування полів в рядки */
      .section label {
        display: inline-block !important;
        width: 120px !important;
        margin-right: 5px !important;
        vertical-align: top !important;
      }
      
      .section input, .section select {
        display: inline-block !important;
        width: 50px !important;
        margin-right: 15px !important;
        margin-bottom: 2px !important;
      }
      
      /* Спеціальні правила для flex-контейнерів */
      .section div[style*="flex"] {
        display: block !important;
      }
      
      .section div[style*="flex"] > div {
        display: inline-block !important;
        margin-right: 20px !important;
        vertical-align: top !important;
      }
      
      /* Приховуємо зайві елементи */
      .tooltip-container {
        display: none !important;
      }
      
      /* Мінімальні відступи */
      br {
        line-height: 0.5 !important;
      }
      
      /* Уникаємо розривів сторінки */
      .section:nth-child(5),
      .section:nth-child(6),
      .section:nth-child(7),
      .section:nth-child(8),
      .section:nth-child(9),
      .section:nth-child(10) {
        page-break-before: avoid !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
    }
    
    /* Стилі для додаткових елементів */
    .element-item {
      background: transparent;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      margin: 2px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .element-item label {
      margin: 0;
      font-weight: 500;
      min-width: 150px;
    }
    .element-item input {
      width: 80px;
      border: 1px solid #d1d5db;
      outline: none;
      background: white;
      border-radius: 4px;
      padding: 4px 8px;
    }
    .remove-btn {
      background: transparent;
      color: black;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .remove-btn:hover {
      background: #f3f4f6;
      color: black;
    }
   </style>
  
</style>
   <!-- Додати jsPDF бібліотеку -->
   <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
   <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="налаштування/calculator-settings.js"></script>
    
    <!-- Fallback CDN для jsPDF -->
    <script>
      if (typeof window.jspdf === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        document.head.appendChild(script);
      }
    </script>
    
    <!-- Fallback CDN для html2canvas -->
    <script>
      if (typeof window.html2canvas === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        document.head.appendChild(script);
      }
    </script>
</head>
<body>
<!-- Кнопка повернення -->
<a href="../index.html" class="back-button">←</a>

<div class="wrapper">
<header>
<div class="title-small header-bar">Калькулятор поінтів (Шафа-гардероб) v1.6</div>
<div class="header-line">
<img src="Картинки/logo2.svg" alt="Logo" class="header-logo">
<label>Проєкт № <input id="projectNum" placeholder="Номер" type="text"/></label>
<label>Назва виробу <input id="productName" placeholder="Назва" type="text"/></label>
<label>Менеджер <input id="managerName" placeholder="Прізвище" type="text"/></label>
<label>Дата 
<input id="dateField" placeholder="Дата автоматично" type="text" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value=""/>
<script>
(function() {
  const dateField = document.getElementById("dateField");
  if (dateField) {
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    dateField.value = `${day}-${month}-${year}`;
  }
})();
</script>
</label>
<button class="no-print" onclick="saveData()">Зберегти</button>
<button class="no-print" onclick="loadData()">Завантажити</button>
<button class="no-print" onclick="downloadPDF()" style="margin-left:8px;background:#1d4ed8;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;">Завантажити PDF</button>
</div>
</header>
<div class="container">
<!-- Розділ 1 -->
<div class="section">
<h3>1. Основні параметри</h3>
<div style="display: flex; gap: 40px; align-items: flex-start;">
  <div>
    <label for="wardrobeForm">Форма шафи:</label><br/>
    <select id="wardrobeForm">
      <option value="">-- Виберіть форму --</option>
      <option value="Пряма">Пряма</option>
      <option value="Г-подібна">Г-подібна</option>
      <option value="П-подібна">П-подібна</option>
      <option value="G-подібна">G-подібна</option>
    </select>
    <br/><br/>
    <label for="installationType">Тип встановлення шафи:</label><br/>
    <select id="installationType">
      <option value="">-- Виберіть --</option>
      <option value="Вбудована">Вбудована</option>
      <option value="Окремостояча">Окремостояча</option>
      <option value="Шафа підвісна">Шафа підвісна</option>
    </select>
    <br/><br/>
    <label for="measure">Заміри:</label><br/>
    <select id="measure">
      <option value="">-- Виберіть --</option>
      <option value="Без замірів">Без замірів</option>
      <option value="По замірам 3D">По замірам 3D</option>
      <option value="По замірам фото-ескіз">По замірам фото-ескіз</option>
    </select>
  </div>

  <div style="margin-left: 30px;">
    <label for="geom">Нестандартна геометрія приміщення:<span class="tooltip-container"><span class="tooltip-icon">?</span><div class="tooltip-content">Наявність колон, вент-шахт, виступів, балок тощо</div></span></label><br/>
    <select id="geom">
      <option value="">-- Виберіть --</option>
      <option value="Так">Так</option>
      <option value="Ні">Ні</option>
    </select>
    <br/><br/>
    <label for="attic">Мансардна шафа:<span class="tooltip-container"><span class="tooltip-icon">?</span><div class="tooltip-content">Скошена стеля тощо</div></span></label><br/>
    <select id="attic">
      <option value="">-- Виберіть --</option>
      <option value="Так">Так</option>
      <option value="Ні">Ні</option>
    </select>
  </div>
</div><!-- Розділ 2 -->
<div class="section">
<h3>2. Матеріали</h3>
<label for="corpus">Матеріал корпусу (шт.):</label>
<input id="corpus" min="0" onfocus="this.select()" type="number" value="0"/><br/><br/>
<label for="glassSelect">Скло-дзеркало:</label>
<select id="glassSelect" onchange="toggleGlassCount()">
<option value="">-- Виберіть --</option>
<option value="Так">Так</option>
<option value="Ні">Ні</option>
</select>
<div class="hidden" id="glassCountWrapper">
<br/>
<label for="glassCount">Кількість скло-дзеркал (шт.):</label>
<input id="glassCount" min="0" onfocus="this.select()" type="number" value="0"/>
</div><br/><br/>

<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
  <label for="hasFacadeMaterials">Фасадні матеріали:</label>
  <select id="hasFacadeMaterials" onchange="toggleFacadeMaterialsFields()">
    <option value="">-- Виберіть --</option>
    <option value="yes">Так</option>
    <option value="no">Ні</option>
  </select>
  <button type="button" id="addFacadeMaterialBtn" onclick="showAddFacadeMaterialModal()" class="hidden" style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
    + Додати матеріал
  </button>
</div>
<div class="hidden" id="facadeMaterialsFields">
<div id="facadeMaterialsList"></div>
</div>

<!-- Модальне вікно для додавання фасадного матеріалу -->
<div id="addFacadeMaterialModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Додати фасадний матеріал</h3>
      <span class="close" onclick="closeAddFacadeMaterialModal()">&times;</span>
    </div>
    <div>
      <label for="newFacadeMaterialType">Тип матеріалу:</label><br/>
      <select id="newFacadeMaterialType" style="width: 100%; margin-bottom: 15px;">
        <option value="">-- Виберіть матеріал --</option>
        <option value="dsp_mat">ДСП мат.корпусу</option>
        <option value="dsp">ДСП</option>
        <option value="mdf">МДФ плити</option>
        <option value="paint_straight">Фарба/плівка "прямі"</option>
        <option value="paint_milled">Фарба/плівка "фрезеровані"</option>
        <option value="veneer_straight">Шпоновані "прямі"</option>
        <option value="veneer_milled">Шпоновані "фрезеровані"</option>
        <option value="alum_frame">Алюм. рамкові</option>
        <option value="arpa">ARPA/Fenix</option>
        <option value="fiushin">Fiushin</option>
        <option value="hpl">HPL</option>
        <option value="rd_individual">R&D фасади індивід.</option>
        <option value="mdf_individual">МДФ фасади з індивідуальним фрезеруванням</option>
      </select>
      
      <label for="newFacadeMaterialTexture">Перехід текстури:</label><br/>
      <select id="newFacadeMaterialTexture" style="width: 100%; margin-bottom: 15px;">
        <option value="">-- Виберіть --</option>
        <option value="yes">Так</option>
        <option value="no">Ні</option>
      </select>
    </div>
    <div class="modal-actions">
      <button onclick="closeAddFacadeMaterialModal()" style="background: #6b7280;">Скасувати</button>
      <button onclick="addFacadeMaterial()" style="background: #2563eb;">Додати</button>
    </div>
  </div>
</div>
<!-- Розділ 3 -->
<div class="section">
<h3>3. Корпуса-модулі</h3>
<label for="sectionsCount">Довжина шафи м/п:</label>
<input id="sectionsCount" onfocus="this.select()" placeholder="Вкажіть довжину в м/п (наприклад: 2.3)" type="text" pattern="[0-9]+(\.[0-9]+)?" title="Введіть число (наприклад: 2.3)"/><br/><br/>
<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
  <label>Типи фасадів:</label>
  <button type="button" id="addFacadeTypeBtn" onclick="showAddFacadeTypeModal()" style="background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">
    + Додати тип фасадів
  </button>
</div>
<div id="facadeFields" style="margin-top: 15px;">
<div id="facadeTypesList"></div>
</div>


<!-- Модальне вікно для додавання типу фасадів -->
<div id="addFacadeTypeModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Додати тип фасадів</h3>
      <span class="close" onclick="closeAddFacadeTypeModal()">&times;</span>
    </div>
    <label for="newFacadeType">Тип фасадів:</label>
    <select id="newFacadeType">
      <option value="">-- Виберіть --</option>
      <option value="none">Без фасадів</option>
      <option value="swing">Фасади роспашні</option>
      <option value="sliding_bottom">Розсувні с-ми (нижньоопорні)</option>
      <option value="sliding_top">Розсувні с-ми (верхньопідвісні)</option>
      <option value="wingline">Складна система WingLine</option>
      <option value="sliding_doors">Системи розсувних дверей (Revego, Hawa, Salice)</option>
      <option value="slide_m">Розсувні с-ми (типу slide М)</option>
    </select>
    <br/><br/>
    <label for="newFacadeTypeCount">Кількість фасадів:</label>
    <input id="newFacadeTypeCount" min="1" onfocus="this.select()" placeholder="Вкажіть кількість або 0" type="number" value="1"/>
    <br/><br/>
    <button type="button" onclick="addNewFacadeType()" style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Додати</button>
  </div>
</div>
<!-- Розділ 5 -->
<div class="section">
<h3>4. Додаткові елементи – конструкції<span class="tooltip-container"><span class="tooltip-icon">?</span><div class="tooltip-content">Фальш горизонтальні<br/>Фальш вертикальні<br/>Деталь R&D, гнутий елемент тощо<br/>Металоконструкція рамкова<br/>Металоконструкція обємна</div></span></h3>
<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
  <select id="hasAdditionalElements" onchange="toggleAdditionalElementsFields()">
    <option value="">-- Виберіть --</option>
    <option value="yes">Так</option>
    <option value="no">Ні</option>
  </select>
  <button type="button" id="addElementBtn" onclick="showAddElementModal()" class="hidden" style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
    + Додати елемент
  </button>
</div>
<div class="hidden" id="additionalElementsFields">
<div id="additionalElementsList"></div>
</div>

<!-- Модальне вікно для додавання елемента -->
<div id="addElementModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Додати елемент</h3>
      <span class="close" onclick="closeAddElementModal()">&times;</span>
    </div>
    <label for="newElementType">Тип елемента:</label>
    <select id="newElementType">
      <option value="">-- Виберіть --</option>
      <option value="false_hor">Фальш горизонтальні</option>
      <option value="false_ver">Фальш вертикальні</option>
      <option value="false_rnd">Деталь R&D, гнутий елемент тощо</option>
      <option value="metal_frame">Металоконструкція рамкова</option>
      <option value="metal_volume">Металоконструкція обємна</option>
    </select>
    <br/><br/>
    <label for="newElementCount">Кількість:</label>
    <input id="newElementCount" min="0" onfocus="this.select()" placeholder="Вкажіть кількість або 0" type="number" value="1"/>
    <br/><br/>
    <button type="button" onclick="addNewElement()" style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Додати</button>
  </div>
</div>

<!-- Модальне вікно для додавання ручки -->
<div id="addHandleModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Додати ручку</h3>
      <span class="close" onclick="closeAddHandleModal()">&times;</span>
    </div>
    <label for="newHandleType">Тип ручки:</label>
    <select id="newHandleType" onchange="addHandleOnSelect()">
      <option value="">-- Виберіть --</option>
      <option value="gola">GOLA</option>
      <option value="end">Торцеві</option>
      <option value="milled">Фрезеровані</option>
      <option value="other">Інші, накладні тощо</option>
    </select>
  </div>
</div>

<!-- Модальне вікно для додавання підсвітки -->
<div id="addLightingModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Додати підсвітку</h3>
      <span class="close" onclick="closeAddLightingModal()">&times;</span>
    </div>
    <label for="newLightingType">Тип підсвітки:</label>
    <select id="newLightingType">
      <option value="">-- Виберіть --</option>
      <option value="elements">К-сть елементів (деталей) з підсвіткою</option>
      <option value="control">К-сть пристроїв керування</option>
    </select>
    <br/><br/>
    <label for="newLightingCount">Кількість:</label>
    <input id="newLightingCount" min="0" onfocus="this.select()" placeholder="Вкажіть кількість або 0" type="number" value="1"/>
    <br/><br/>
    <button type="button" onclick="addNewLighting()" style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Додати</button>
  </div>
</div>

<!-- Модальне вікно для додавання вбудованої техніки -->
<div id="addApplianceModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Додати техніку</h3>
      <span class="close" onclick="closeAddApplianceModal()">&times;</span>
    </div>
    <label for="newApplianceType">Тип техніки:</label>
    <select id="newApplianceType" onchange="addApplianceOnSelect()">
      <option value="">-- Виберіть --</option>
      <option value="tech_hatch">Люк технічний (ревізійний, електро тощо)</option>
      <option value="tech_appliance">Техніка (пралка, сушка, сейф, винна шафа тощо)</option>
    </select>
    <br/><br/>
    <label for="newApplianceQuantity">Кількість:</label>
    <input id="newApplianceQuantity" min="1" type="number" value="1" placeholder="Вкажіть кількість або 0"/>
    <div class="modal-actions">
      <button onclick="addApplianceFromModal()">Додати</button>
      <button onclick="closeAddApplianceModal()">Скасувати</button>
    </div>
  </div>
</div>
</div>
<!-- Розділ 6 -->
<div class="section">
<h3>5. Функціональна фурнітура</h3>
<label for="furnDrawers">Ящики:</label>
<input id="furnDrawers" min="0" onfocus="this.select()" placeholder="Вкажіть кількість або 0" type="number"/><br/><br/>
<label for="furnLifts">Підйомні механізми:</label>
<input id="furnLifts" min="0" onfocus="this.select()" placeholder="Вкажіть кількість або 0" type="number"/><br/><br/>
<label for="furnAccessories">Аксесуари до шафи: кошики, пантограф, тощо:</label>
<input id="furnAccessories" min="0" onfocus="this.select()" placeholder="Вкажіть кількість або 0" type="number"/><br/><br/>
<label for="furnHangingRods">К-сть штанг для одягу:</label>
<input id="furnHangingRods" min="0" onfocus="this.select()" placeholder="Вкажіть кількість або 0" type="number"/><br/><br/>
<label for="furnBarMechanisms">Барні механізми:</label>
<input id="furnBarMechanisms" min="0" onfocus="this.select()" placeholder="Вкажіть кількість або 0" type="number"/>
</div>
<!-- Розділ 7 -->
<div class="section">
<h3>6. Ручки</h3>
<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
  <select id="hasHandles" onchange="toggleHandlesFields()">
    <option value="">-- Виберіть --</option>
    <option value="yes">Так</option>
    <option value="no">Ні</option>
  </select>
  <button type="button" id="addHandleBtn" onclick="showAddHandleModal()" class="hidden" style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
    + Додати ручку
  </button>
</div>
<div class="hidden" id="handlesFields">
<div id="handlesList"></div>
</div>
</div>
<script>
        function updateHandles() {
          const container = document.getElementById("handlesContainer");
          container.innerHTML = "";
          const count = parseInt(document.getElementById("handlesCount").value);
          if (!isNaN(count) && count > 0) {
            for (let i = 1; i <= count; i++) {
              const label = document.createElement("label");
              label.innerText = "Вид ручок №" + i + ":";
              const select = document.createElement("select");
              select.id = "handle" + i;
              select.innerHTML = `
                <option value="">-- Виберіть --</option>
                <option value="GOLA">GOLA</option>
                <option value="Торцеві">Торцеві</option>
                <option value="Фрезеровані">Фрезеровані</option>
                <option value="Інші, накладні тощо">Інші, накладні тощо</option>
              `;
              container.appendChild(document.createElement("br"));
              container.appendChild(label);
              container.appendChild(select);
              container.appendChild(document.createElement("br"));
            }
          }
        }
      </script>
<!-- Розділ 8 -->
<div class="section">
<h3>7. Підсвітка</h3>
<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
  <select id="hasLighting" onchange="toggleLightingFields()">
    <option value="">-- Виберіть --</option>
    <option value="yes">Так</option>
    <option value="no">Ні</option>
  </select>
  <button type="button" id="addLightingBtn" onclick="showAddLightingModal()" class="hidden" style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
    + Додати підсвітку
  </button>
</div>
<div class="hidden" id="lightingFields">
<div id="lightingList"></div>
</div>
<h3>8. Вбудована техніка</h3>
<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
  <select id="hasAppliances" onchange="toggleAppliancesFields()">
    <option value="">-- Виберіть --</option>
    <option value="yes">Так</option>
    <option value="no">Ні</option>
  </select>
  <button type="button" id="addApplianceBtn" onclick="showAddApplianceModal()" class="hidden" style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
    + Додати техніку
  </button>
</div>
<div class="hidden" id="appliancesFields">
<div id="appliancesList"></div>
</div>
</div>
<button class="no-print" onclick="calculate()">Розрахувати</button>
<div id="pointsResult" style="margin-top: 15px; padding: 15px; background: #e0f2fe; border: 2px solid #0369a1; border-radius: 8px; font-size: 18px; font-weight: bold; color: #0c4a6e; text-align: center; display: none;">
  Результат: <span id="pointsValue">0</span> поінтів
</div>

</div>
</div>

<!-- Лічильник поінтів (тестовий варіант) -->
<div id="pointsDisplay" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: red; color: white; padding: 30px; border: 5px solid yellow; z-index: 99999; font-size: 24px; font-weight: bold; text-align: center; display: none;">
  <div>ПОІНТИ:</div>
  <div id="currentPoints" style="font-size: 40px;">0</div>
</div>

<!-- Модальне вікно -->
<div class="modal" id="warningModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
  <div class="modal-content">
    <h3>⚠️ Помилка</h3>
    <p id="warningText"></p>
    <button onclick="closeModal()">OK</button>
  </div>
</div>
<script>
    const facadeOptions = [
      "ДСП мат. корпусу","ДСП","МДФ плити","Фарба/плівка 'прямі'","Фарба/плівка 'фрезеровані'",
      "Шпоновані 'прямі'","Шпоновані 'фрезеровані'","Алюм. рамкові","ARPA/Fenix",
      "Fiushin","HPL","R&D фасади індивід.","МДФ фасади з індивідуальним фрезеруванням"
    ];

    function generateFacades() {
      const count = parseInt(document.getElementById("facadeCount").value) || 0;
      const container = document.getElementById("facadeContainer");
      container.innerHTML = "";
      if (count > 13) return;
      for (let i = 1; i <= count; i++) {
        const label = document.createElement("label");
        label.innerText = "Матеріал фасадів №" + i + ":";
        const select = document.createElement("select");
        select.id = "facade_" + i;
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "-- Виберіть --";
        select.appendChild(defaultOption);
        facadeOptions.forEach(opt => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          select.appendChild(option);
        });
        container.appendChild(label);
        container.appendChild(select);
        container.appendChild(document.createElement("br"));
      }
    }

    
    function toggleGlassCount() {
      const glass = document.getElementById("glassSelect").value;
      const wrapper = document.getElementById("glassCountWrapper");
      wrapper.classList.toggle("hidden", glass !== "Так");
    }


    function toggleLightingFields() {
      const hasLighting = document.getElementById("hasLighting").value;
      const fields = document.getElementById("lightingFields");
      const addButton = document.getElementById("addLightingBtn");
      
      if (hasLighting === "yes") {
        fields.classList.remove("hidden");
        addButton.classList.remove("hidden");
      } else {
        fields.classList.add("hidden");
        addButton.classList.add("hidden");
      }
    }

    function toggleAppliancesFields() {
      const hasAppliances = document.getElementById("hasAppliances").value;
      const fields = document.getElementById("appliancesFields");
      const addButton = document.getElementById("addApplianceBtn");
      
      if (hasAppliances === "yes") {
        fields.classList.remove("hidden");
        addButton.classList.remove("hidden");
      } else {
        fields.classList.add("hidden");
        addButton.classList.add("hidden");
      }
    }
    
    function toggleHandlesFields() {
      const hasHandles = document.getElementById("hasHandles").value;
      const fields = document.getElementById("handlesFields");
      const addButton = document.getElementById("addHandleBtn");
      
      if (hasHandles === "yes") {
        fields.classList.remove("hidden");
        addButton.classList.remove("hidden");
      } else {
        fields.classList.add("hidden");
        addButton.classList.add("hidden");
      }
    }
    
    function toggleAdditionalElementsFields() {
      const hasAdditionalElements = document.getElementById("hasAdditionalElements").value;
      const fields = document.getElementById("additionalElementsFields");
      const addButton = document.getElementById("addElementBtn");
      
      if (hasAdditionalElements === "yes") {
        fields.classList.remove("hidden");
        addButton.classList.remove("hidden");
      } else {
        fields.classList.add("hidden");
        addButton.classList.add("hidden");
      }
    }

    function toggleFacadeFields() {
      const facadeType = document.getElementById("facadeType").value;
      const fields = document.getElementById("facadeFields");
      const addButton = document.getElementById("addFacadeTypeBtn");
      
      if (facadeType === "swing" || facadeType === "sliding") {
        fields.classList.remove("hidden");
        addButton.classList.remove("hidden");
      } else {
        fields.classList.add("hidden");
        addButton.classList.add("hidden");
      }
    }

    function toggleFacadeMaterialsFields() {
      const hasFacadeMaterials = document.getElementById("hasFacadeMaterials").value;
      const fields = document.getElementById("facadeMaterialsFields");
      const addButton = document.getElementById("addFacadeMaterialBtn");
      
      if (hasFacadeMaterials === "yes") {
        fields.classList.remove("hidden");
        addButton.classList.remove("hidden");
      } else {
        fields.classList.add("hidden");
        addButton.classList.add("hidden");
      }
    }

    let additionalElementsCounter = 0;
    let facadeMaterialsCounter = 0;
    let facadeTypesCounter = 0;
    let handlesCounter = 0;
    let lightingCounter = 0;
    let appliancesCounter = 0;

    function showAddElementModal() {
      document.getElementById('addElementModal').style.display = 'flex';
    }

    function showAddFacadeMaterialModal() {
      document.getElementById('addFacadeMaterialModal').style.display = 'flex';
    }

    function closeAddFacadeMaterialModal() {
  document.getElementById('addFacadeMaterialModal').style.display = 'none';
  // Скидаємо поля
  document.getElementById('newFacadeMaterialType').value = '';
  document.getElementById('newFacadeMaterialTexture').value = '';
}

function addFacadeMaterial() {
  const materialType = document.getElementById("newFacadeMaterialType").value;
  const texture = document.getElementById("newFacadeMaterialTexture").value;
  
  if (!materialType || !texture) {
    alert('Будь ласка, заповніть всі поля');
    return;
  }

  const materialNames = {
    "dsp_mat": "ДСП мат.корпусу",
    "dsp": "ДСП",
    "mdf": "МДФ плити",
    "paint_straight": "Фарба/плівка \"прямі\"",
    "paint_milled": "Фарба/плівка \"фрезеровані\"",
    "veneer_straight": "Шпоновані \"прямі\"",
    "veneer_milled": "Шпоновані \"фрезеровані\"",
    "alum_frame": "Алюм. рамкові",
    "arpa": "ARPA/Fenix",
    "fiushin": "Fiushin",
    "hpl": "HPL",
    "rd_individual": "R&D фасади індивід.",
    "mdf_individual": "МДФ фасади з індивідуальним фрезеруванням"
  };

  const textureNames = {
    "yes": "з текстурою",
    "no": "без текстури"
  };

  const materialName = materialNames[materialType];
  const textureName = textureNames[texture];
  
  if (!materialName) return;

  facadeMaterialsCounter++;
  const materialId = `facadeMaterial_${facadeMaterialsCounter}`;
  
  const materialDiv = document.createElement('div');
  materialDiv.className = 'element-item';
  materialDiv.id = materialId;
  materialDiv.setAttribute('data-material-type', materialType);
  materialDiv.setAttribute('data-texture', texture);
  
  materialDiv.innerHTML = `
    <label>${facadeMaterialsCounter}. Матеріал фасада: ${materialName}, ${textureName}</label>
    <button type="button" class="remove-btn" onclick="removeFacadeMaterial('${materialId}')">×</button>
  `;
  
  document.getElementById('facadeMaterialsList').appendChild(materialDiv);
  
  // Закриваємо модальне вікно
  closeAddFacadeMaterialModal();
  
  // Оновлюємо поінти
  updatePointsDisplay();
}

    function removeFacadeMaterial(materialId) {
      const material = document.getElementById(materialId);
      if (material) {
        material.remove();
        // Оновлюємо поінти
        updatePointsDisplay();
      }
    }

    function showAddFacadeTypeModal() {
      document.getElementById('addFacadeTypeModal').style.display = 'flex';
    }

    function closeAddFacadeTypeModal() {
      document.getElementById('addFacadeTypeModal').style.display = 'none';
      // Скидаємо поля
      document.getElementById('newFacadeType').value = '';
      document.getElementById('newFacadeTypeCount').value = '1';
    }

    function addNewFacadeType() {
      const facadeType = document.getElementById("newFacadeType").value;
      const facadeCount = document.getElementById("newFacadeTypeCount").value;
      
      if (!facadeType) {
        alert("Будь ласка, виберіть тип фасаду");
        return;
      }
      if (!facadeCount || parseInt(facadeCount) < 1) {
        alert("Будь ласка, вкажіть кількість фасадів");
        return;
      }

      const typeNames = {
        "none": "Без фасадів",
        "swing": "Фасади роспашні",
        "sliding_bottom": "Розсувні с-ми (нижньоопорні)",
        "sliding_top": "Розсувні с-ми (верхньопідвісні)",
        "wingline": "Складна система WingLine",
        "sliding_doors": "Системи розсувних дверей (Revego, Hawa, Salice)",
        "slide_m": "Розсувні с-ми (типу slide М)"
      };

      const typeName = typeNames[facadeType];
      if (!typeName) return;

      facadeTypesCounter++;
      const typeId = `facadeType_${facadeTypesCounter}`;
      
      const typeDiv = document.createElement('div');
      typeDiv.className = 'element-item';
      typeDiv.id = typeId;
      
      typeDiv.innerHTML = `
        <label>${facadeTypesCounter}. Тип фасадів: ${typeName}:</label>
        <input id="${typeId}_count" min="0" onfocus="this.select()" placeholder="Кількість" type="number" value="${facadeCount}"/>
        <button type="button" class="remove-btn" onclick="removeFacadeType('${typeId}')">×</button>
      `;
      
      document.getElementById('facadeTypesList').appendChild(typeDiv);
      
      // Закриваємо модальне вікно
      closeAddFacadeTypeModal();
      
      // Оновлюємо поінти
      updatePointsDisplay();
    }

    function removeFacadeType(typeId) {
      const type = document.getElementById(typeId);
      if (type) {
        type.remove();
        // Оновлюємо поінти
        updatePointsDisplay();
      }
    }

    function closeAddElementModal() {
      document.getElementById('addElementModal').style.display = 'none';
      // Скидаємо поля
      document.getElementById('newElementType').value = '';
      document.getElementById('newElementCount').value = '1';
    }

    function addNewElement() {
      const elementType = document.getElementById("newElementType").value;
      const elementCount = document.getElementById("newElementCount").value;
      
      if (!elementType) {
        alert("Будь ласка, виберіть тип елемента");
        return;
      }
      if (!elementCount || parseInt(elementCount) < 1) {
        alert("Будь ласка, вкажіть кількість елемента");
        return;
      }

      const elementNames = {
        "false_hor": "Фальш горизонтальні",
        "false_ver": "Фальш вертикальні", 
        "false_rnd": "Деталь R&D, гнутий елемент тощо",
        "metal_frame": "Металоконструкція рамкова",
        "metal_volume": "Металоконструкція обємна"
      };

      const elementName = elementNames[elementType];
      if (!elementName) return;

      additionalElementsCounter++;
      const elementId = `additionalElement_${additionalElementsCounter}`;
      
      const elementDiv = document.createElement('div');
      elementDiv.className = 'element-item';
      elementDiv.id = elementId;
      elementDiv.setAttribute('data-element-type', elementType);
      
      elementDiv.innerHTML = `
        <label>${additionalElementsCounter}. ${elementName}:</label>
        <input id="${elementId}_count" min="0" onfocus="this.select()" placeholder="Кількість" type="number" value="${elementCount}"/>
        <button type="button" class="remove-btn" onclick="removeAdditionalElement('${elementId}')">×</button>
      `;
      
      document.getElementById('additionalElementsList').appendChild(elementDiv);
      
      // Закриваємо модальне вікно
      closeAddElementModal();
      
      // Оновлюємо поінти
      updatePointsDisplay();
    }

    function removeAdditionalElement(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        element.remove();
        // Перенумеровуємо елементи
        renumberAdditionalElements();
        // Оновлюємо поінти
        updatePointsDisplay();
      }
    }

    function renumberAdditionalElements() {
      const elements = document.querySelectorAll('#additionalElementsList .element-item');
      elements.forEach((element, index) => {
        const label = element.querySelector('label');
        if (label) {
          const text = label.textContent;
          const newText = text.replace(/^\d+\.\s*/, `${index + 1}. `);
          label.textContent = newText;
        }
      });
    }

    // Функції для роботи з ручками
    function showAddHandleModal() {
      document.getElementById('addHandleModal').style.display = 'flex';
    }

    function closeAddHandleModal() {
      document.getElementById('addHandleModal').style.display = 'none';
      document.getElementById('newHandleType').value = '';
    }

    function addHandleOnSelect() {
      const handleType = document.getElementById("newHandleType").value;
      
      if (!handleType) {
        alert("Будь ласка, виберіть тип ручок");
        return;
      }

      const handleNames = {
        "gola": "GOLA",
        "end": "Торцеві",
        "milled": "Фрезеровані",
        "other": "Інші, накладні тощо"
      };

      const handleName = handleNames[handleType];
      if (!handleName) return;

      handlesCounter++;
      const handleId = `handle_${handlesCounter}`;
      
      const handleDiv = document.createElement('div');
      handleDiv.className = 'element-item';
      handleDiv.id = handleId;
      
      handleDiv.innerHTML = `
        <label>${handlesCounter}. Ручка: ${handleName}</label>
        <button type="button" class="remove-btn" onclick="removeHandle('${handleId}')">×</button>
      `;
      
      document.getElementById('handlesList').appendChild(handleDiv);
      
      // Закриваємо модальне вікно
      closeAddHandleModal();
      
      // Оновлюємо поінти
      updatePointsDisplay();
    }

    function removeHandle(handleId) {
      const handle = document.getElementById(handleId);
      if (handle) {
        handle.remove();
        // Перенумеровуємо ручки
        renumberHandles();
        // Оновлюємо поінти
        updatePointsDisplay();
      }
    }

    function renumberHandles() {
      const handles = document.querySelectorAll('#handlesList .element-item');
      handles.forEach((handle, index) => {
        const label = handle.querySelector('label');
        if (label) {
          const text = label.textContent;
          const newText = text.replace(/^\d+\.\s*/, `${index + 1}. `);
          label.textContent = newText;
        }
      });
    }

    // Функції для роботи з підсвіткою
    function showAddLightingModal() {
      document.getElementById('addLightingModal').style.display = 'flex';
    }

    function closeAddLightingModal() {
      document.getElementById('addLightingModal').style.display = 'none';
      document.getElementById('newLightingType').value = '';
      document.getElementById('newLightingCount').value = '1';
    }

    function addNewLighting() {
      const lightingType = document.getElementById("newLightingType").value;
      const lightingCount = document.getElementById("newLightingCount").value;
      
      if (!lightingType) {
        alert("Будь ласка, виберіть тип підсвітки");
        return;
      }
      if (!lightingCount || parseInt(lightingCount) < 1) {
        alert("Будь ласка, вкажіть кількість підсвітки");
        return;
      }

      const lightingNames = {
        "elements": "К-сть елементів (деталей) з підсвіткою",
        "control": "К-сть пристроїв керування"
      };

      const lightingName = lightingNames[lightingType];
      if (!lightingName) return;

      lightingCounter++;
      const lightingId = `lighting_${lightingCounter}`;
      
      const lightingDiv = document.createElement('div');
      lightingDiv.className = 'element-item';
      lightingDiv.id = lightingId;
      
      lightingDiv.innerHTML = `
        <label>${lightingCounter}. ${lightingName}:</label>
        <input id="${lightingId}_count" min="0" onfocus="this.select()" placeholder="Кількість" type="number" value="${lightingCount}"/>
        <button type="button" class="remove-btn" onclick="removeLighting('${lightingId}')">×</button>
      `;
      
      document.getElementById('lightingList').appendChild(lightingDiv);
      
      // Закриваємо модальне вікно
      closeAddLightingModal();
      
      // Оновлюємо поінти
      updatePointsDisplay();
    }

    function removeLighting(lightingId) {
      const lighting = document.getElementById(lightingId);
      if (lighting) {
        lighting.remove();
        // Перенумеровуємо підсвітку
        renumberLighting();
        // Оновлюємо поінти
        updatePointsDisplay();
      }
    }

    function renumberLighting() {
      const lightings = document.querySelectorAll('#lightingList .element-item');
      lightings.forEach((lighting, index) => {
        const label = lighting.querySelector('label');
        if (label) {
          const text = label.textContent;
          const newText = text.replace(/^\d+\.\s*/, `${index + 1}. `);
          label.textContent = newText;
        }
      });
    }

    // Функції для роботи з вбудованою технікою
    function showAddApplianceModal() {
      document.getElementById('addApplianceModal').style.display = 'flex';
    }

    function closeAddApplianceModal() {
      document.getElementById('addApplianceModal').style.display = 'none';
      document.getElementById('newApplianceType').value = '';
      document.getElementById('newApplianceQuantity').value = '1';
    }

    function addApplianceOnSelect() {
      // Функція викликається при виборі типу техніки
    }

    function addApplianceFromModal() {
      const applianceType = document.getElementById("newApplianceType").value;
      const quantity = document.getElementById("newApplianceQuantity").value;
      
      if (!applianceType) {
        alert("Будь ласка, виберіть тип техніки");
        return;
      }
      
      if (!quantity || parseInt(quantity) < 1) {
        alert("Будь ласка, вкажіть кількість техніки (мінімум 1)");
        return;
      }

      appliancesCounter++;
      const applianceId = `appliance_${appliancesCounter}`;
      
      const applianceNames = {
        "tech_hatch": "Люк технічний (ревізійний, електро тощо)",
        "tech_appliance": "Техніка (пралка, сушка, сейф, винна шафа тощо)"
      };
      
      const displayName = applianceNames[applianceType] || applianceType;
      
      const applianceDiv = document.createElement('div');
      applianceDiv.className = 'element-item';
      applianceDiv.id = applianceId;
      applianceDiv.setAttribute('data-appliance-type', applianceType);
      applianceDiv.setAttribute('data-quantity', quantity);
      
      applianceDiv.innerHTML = `
        <label>${appliancesCounter}. ${displayName} (${quantity} шт.):</label>
        <input id="${applianceId}_count" min="1" onfocus="this.select()" placeholder="Вкажіть кількість або 0" type="number" value="${quantity}"/>
        <button type="button" class="remove-btn" onclick="removeAppliance('${applianceId}')">×</button>
      `;
      
      document.getElementById('appliancesList').appendChild(applianceDiv);
      
      // Оновлюємо нумерацію
      updateApplianceNumbers();
      
      // Закриваємо модальне вікно
      closeAddApplianceModal();
      
      // Оновлюємо поінти
      updatePointsDisplay();
    }

    function updateApplianceNumbers() {
      const appliances = document.querySelectorAll('#appliancesList .element-item');
      const applianceNames = {
        "tech_hatch": "Люк технічний (ревізійний, електро тощо)",
        "tech_appliance": "Техніка (пралка, сушка, сейф, винна шафа тощо)"
      };
      
      appliances.forEach((appliance, index) => {
        const applianceType = appliance.getAttribute('data-appliance-type');
        const quantity = appliance.getAttribute('data-quantity');
        const displayName = applianceNames[applianceType] || applianceType;
        const label = appliance.querySelector('label');
        if (label) {
          label.textContent = `${index + 1}. ${displayName} (${quantity} шт.):`;
        }
      });
    }

    function removeAppliance(applianceId) {
      const appliance = document.getElementById(applianceId);
      if (appliance) {
        appliance.remove();
        // Оновлюємо нумерацію
        updateApplianceNumbers();
        // Оновлюємо поінти
        updatePointsDisplay();
      }
    }

    // Додаємо обробники подій для оновлення поінтів в реальному часі
    function addRealTimeListeners() {
      // Основні параметри
      document.getElementById("wardrobeForm").addEventListener("change", updatePointsDisplay);
      document.getElementById("measure").addEventListener("change", updatePointsDisplay);
      document.getElementById("geom").addEventListener("change", updatePointsDisplay);
      document.getElementById("attic").addEventListener("change", updatePointsDisplay);
      
      // Матеріали
      document.getElementById("corpus").addEventListener("input", updatePointsDisplay);
      document.getElementById("glassSelect").addEventListener("change", function() {
        toggleGlassCount();
        updatePointsDisplay();
      });
      document.getElementById("glassCount").addEventListener("input", updatePointsDisplay);
      
      // Корпуса-модулі
      document.getElementById("sectionsCount").addEventListener("input", updatePointsDisplay);
      
      // Функціональна фурнітура
      document.getElementById("furnDrawers").addEventListener("input", updatePointsDisplay);
      document.getElementById("furnLifts").addEventListener("input", updatePointsDisplay);
      document.getElementById("furnAccessories").addEventListener("input", updatePointsDisplay);
      document.getElementById("furnHangingRods").addEventListener("input", updatePointsDisplay);
      document.getElementById("furnBarMechanisms").addEventListener("input", updatePointsDisplay);
      
      // Фасадні матеріали
      document.getElementById("hasFacadeMaterials").addEventListener("change", updatePointsDisplay);
      
      // Типи фасадів - обробник вже додано вище для facadeType
      
      // Додаткові елементи
      document.getElementById("hasAdditionalElements").addEventListener("change", updatePointsDisplay);
      
      // Додаємо обробники для динамічно створених полів вводу кількості
      document.addEventListener("input", function(e) {
        if (e.target.matches('input[type="number"]') && e.target.id.includes('_count')) {
          updatePointsDisplay();
        }
      });
      
      // Також додаємо обробник для change події (на випадок, якщо input не спрацьовує)
      document.addEventListener("change", function(e) {
        if (e.target.matches('input[type="number"]') && e.target.id.includes('_count')) {
          updatePointsDisplay();
        }
      });
      
      // Ручки
      document.getElementById("hasHandles").addEventListener("change", updatePointsDisplay);
      
      // Підсвітка
      document.getElementById("hasLighting").addEventListener("change", updatePointsDisplay);
      
      // Вбудована техніка
      document.getElementById("hasAppliances").addEventListener("change", updatePointsDisplay);
    }

    // Мапінг фасадних матеріалів
    const facadeMaterialMapping = {
      "ДСП мат.корпусу": "p_wardrobe_facade_dsp_mat",
      "ДСП": "p_wardrobe_facade_dsp",
      "МДФ плити": "p_wardrobe_facade_mdf",
      "Фарба/плівка \"прямі\"": "p_wardrobe_facade_paint_straight",
      "Фарба/плівка \"фрезеровані\"": "p_wardrobe_facade_paint_milled",
      "Шпоновані \"прямі\"": "p_wardrobe_facade_veneer_straight",
      "Шпоновані \"фрезеровані\"": "p_wardrobe_facade_veneer_milled",
      "Алюм. рамкові": "p_wardrobe_facade_alum_frame",
      "ARPA/Fenix": "p_wardrobe_facade_arpa",
      "Fiushin": "p_wardrobe_facade_fiushin",
      "HPL": "p_wardrobe_facade_hpl",
      "R&D фасади індивід.": "p_wardrobe_facade_rd_individual",
      "МДФ фасади з індивідуальним фрезеруванням": "p_wardrobe_facade_mdf_individual"
    };

    // Мапінг типів фасадів
    const facadeTypeMapping = {
      "swing": "p_wardrobe_swing_facades",
      "sliding": "p_wardrobe_furn_sliding_bottom"
    };

    // Функція для оновлення поінтів в реальному часі
    function updatePointsDisplay() {
      try {
        let totalPoints = 0;
      
        // Розрахунок поінтів для всіх розділів
        // 1. Основні параметри
        const form = document.getElementById("wardrobeForm")?.value;
        const measure = document.getElementById("measure")?.value;
        const geom = document.getElementById("geom")?.value;
        const attic = document.getElementById("attic")?.value;
        
        // Рахуємо поінти для кожного заповненого поля окремо
        if (form === "Пряма") {
          const tariff = getSettingValue("p_wardrobe_forma_pryama");
          totalPoints += tariff;
        } else if (form === "Г-подібна") {
          const tariff = getSettingValue("p_wardrobe_forma_g");
          totalPoints += tariff;
        } else if (form === "П-подібна") {
          const tariff = getSettingValue("p_wardrobe_forma_p");
          totalPoints += tariff;
        }
        
        if (measure === "Без замірів") {
          const tariff = getSettingValue("p_wardrobe_zamir_none");
          totalPoints += tariff;
        } else if (measure === "По замірам 3D") {
          const tariff = getSettingValue("p_wardrobe_zamir_3d");
          totalPoints += tariff;
        } else if (measure === "По замірам фото-ескіз") {
          const tariff = getSettingValue("p_wardrobe_zamir_photo");
          totalPoints += tariff;
        }
        
        if (geom === "Так") {
          const tariff = getSettingValue("p_wardrobe_geo");
          totalPoints += tariff;
        }
        
        if (attic === "Так") {
          const tariff = getSettingValue("p_wardrobe_attic");
          totalPoints += tariff;
        }
        
        // 2. Матеріали
        const corpus = parseInt(document.getElementById("corpus")?.value) || 0;
        if (corpus > 0) {
          const tariff = getSettingValue("p_mat_corpus");
          totalPoints += corpus * tariff;
        }
        
        const glassSelect = document.getElementById("glassSelect")?.value;
        if (glassSelect === "Так") {
          const glassCount = parseInt(document.getElementById("glassCount")?.value) || 0;
          if (glassCount > 0) {
            const tariff = getSettingValue("p_mat_glass");
            totalPoints += glassCount * tariff;
          }
        }
        
        // 3. Корпуса-модулі
        const sections = parseInt(document.getElementById("sectionsCount")?.value) || 0;
        if (sections > 0) {
          const tariff = getSettingValue("p_sections");
          totalPoints += sections * tariff;
        }
        
        // 3.1. Типи фасадів (нова система)
        const facadeTypes = document.querySelectorAll('#facadeTypesList .element-item');
        facadeTypes.forEach(type => {
          const countInput = type.querySelector('input[type="number"]');
          const count = countInput ? parseInt(countInput.value) || 0 : 0;
          const facadeType = type.getAttribute('data-facade-type');
            
          if (count > 0 && facadeType) {
            let tariffId = "";
            if (facadeType === 'none') {
              tariffId = "p_wardrobe_facade_none";
              // Для "Без фасадів" рахуємо як 1, незалежно від кількості
              totalPoints += 1 * getSettingValue(tariffId);
              return; // Виходимо з циклу, не рахуємо кількість
            } else if (facadeType === 'swing') {
              tariffId = "p_wardrobe_swing_facades";
            } else if (facadeType === 'sliding_bottom') {
              tariffId = "p_wardrobe_furn_sliding_bottom";
            } else if (facadeType === 'sliding_top') {
              tariffId = "p_wardrobe_furn_sliding_top";
            } else if (facadeType === 'wingline') {
              tariffId = "p_wardrobe_furn_wingline";
            } else if (facadeType === 'sliding_doors') {
              tariffId = "p_wardrobe_furn_doors";
            } else if (facadeType === 'slide_m') {
              tariffId = "p_wardrobe_furn_slide";
            }
            
            if (tariffId) {
              const tariff = getSettingValue(tariffId);
              totalPoints += count * tariff; // Множимо на кількість, як у підсвітки
            }
          }
        });
        
        // 2.1. Фасадні матеріали
        const hasFacadeMaterials = document.getElementById("hasFacadeMaterials")?.value;
        if (hasFacadeMaterials === "yes") {
          const facadeMaterials = document.querySelectorAll('[id^="facadeMaterial_"]');
          facadeMaterials.forEach(material => {
            const label = material.querySelector('label');
            if (label) {
              const materialName = label.textContent.split(': ')[1]; // Отримуємо назву після ": "
              const tariffId = facadeMaterialMapping[materialName];
              if (tariffId) {
                const tariff = getSettingValue(tariffId);
                totalPoints += tariff; // Кожен матеріал рахується як 1
              }
            }
          });
        }
        
        
        // 3.2. Функціональна фурнітура
        const furnDrawers = parseInt(document.getElementById("furnDrawers")?.value) || 0;
        if (furnDrawers > 0) {
          const tariff = getSettingValue("p_wardrobe_furn_drawers");
          totalPoints += furnDrawers * tariff;
        }
        
        const furnLifts = parseInt(document.getElementById("furnLifts")?.value) || 0;
        if (furnLifts > 0) {
          const tariff = getSettingValue("p_wardrobe_furn_lifts");
          totalPoints += furnLifts * tariff;
        }
        
        const furnAccessories = parseInt(document.getElementById("furnAccessories")?.value) || 0;
        if (furnAccessories > 0) {
          const tariff = getSettingValue("p_wardrobe_furn_accessories");
          totalPoints += furnAccessories * tariff;
        }
        
        const furnHangingRods = parseInt(document.getElementById("furnHangingRods")?.value) || 0;
        if (furnHangingRods > 0) {
          const tariff = getSettingValue("p_wardrobe_furn_hanging_rods");
          totalPoints += furnHangingRods * tariff;
        }
        
        const furnBarMechanisms = parseInt(document.getElementById("furnBarMechanisms")?.value) || 0;
        if (furnBarMechanisms > 0) {
          const tariff = getSettingValue("p_wardrobe_furn_bar_mechanisms");
          totalPoints += furnBarMechanisms * tariff;
        }
        
        
        // 4. Додаткові елементи
        const hasAdditionalElements = document.getElementById("hasAdditionalElements")?.value;
        if (hasAdditionalElements === "yes") {
          const additionalElements = document.querySelectorAll('#additionalElementsList .element-item');
          additionalElements.forEach(element => {
            const countInput = element.querySelector('input[type="number"]');
            if (countInput) {
              const count = parseInt(countInput.value) || 0;
              if (count > 0) {
                const elementType = element.getAttribute('data-element-type');
                let tariffId = "p_additional_element";
                if (elementType === "false_hor") tariffId = "p_wardrobe_false_hor";
                else if (elementType === "false_ver") tariffId = "p_wardrobe_false_ver";
                else if (elementType === "false_rnd") tariffId = "p_wardrobe_false_rnd";
                else if (elementType === "metal") tariffId = "p_wardrobe_metal_frame";
                else if (elementType === "radius") tariffId = "p_wardrobe_metal_volume";
                
                const tariff = getSettingValue(tariffId);
                totalPoints += count * tariff;
              }
            }
          });
        }
        
        // 5. Ручки
        const hasHandles = document.getElementById("hasHandles")?.value;
        if (hasHandles === "yes") {
          const handles = document.querySelectorAll('#handlesList .element-item');
          handles.forEach(handle => {
            const handleType = handle.getAttribute('data-handle-type');
            let tariffId = "p_handle";
            if (handleType === "gola") tariffId = "p_wardrobe_handle_gola_low";
            else if (handleType === "end") tariffId = "p_wardrobe_handle_end";
            else if (handleType === "milled") tariffId = "p_wardrobe_handle_milled";
            else if (handleType === "other") tariffId = "p_wardrobe_handle_other";
            
            const tariff = getSettingValue(tariffId);
            totalPoints += tariff;
          });
        }
        
        // 6. Підсвітка
        const hasLighting = document.getElementById("hasLighting")?.value;
        if (hasLighting === "yes") {
          const lightingItems = document.querySelectorAll('#lightingList .element-item');
          lightingItems.forEach(item => {
            const countInput = item.querySelector('input[type="number"]');
            if (countInput) {
              const count = parseInt(countInput.value) || 0;
              if (count > 0) {
                const lightingType = item.getAttribute('data-lighting-type');
                let tariffId = "p_lighting";
                if (lightingType === "elements") tariffId = "p_wardrobe_light_mod";
                else if (lightingType === "control") tariffId = "p_wardrobe_light_work";
                
                const tariff = getSettingValue(tariffId);
                totalPoints += count * tariff;
              }
            }
          });
        }
        
        // 7. Вбудована техніка
        const hasAppliances = document.getElementById("hasAppliances")?.value;
        if (hasAppliances === "yes") {
          const appliances = document.querySelectorAll('#appliancesList .element-item');
          const applianceMapping = {
            "tech_hatch": "p_wardrobe_tech_hatch",
            "tech_appliance": "p_wardrobe_tech_appliance"
          };
          
          appliances.forEach(appliance => {
            const applianceType = appliance.getAttribute('data-appliance-type');
            const quantity = parseInt(appliance.getAttribute('data-quantity')) || 0;
            if (applianceType && quantity > 0) {
              const tariffId = applianceMapping[applianceType];
              if (tariffId) {
                const tariff = getSettingValue(tariffId);
                totalPoints += quantity * tariff;
              }
            }
          });
        }
        
        // Логіка оновлення поінтів (не показуємо лічильник в реальному часі)
        // Лічільник буде показаний тільки після натискання "Розрахувати"
      } catch (error) {
        // Обробка помилок
      }
    }


    async function calculate() {
      // Перевіряємо всі обов'язкові поля
      const missingFields = checkRequiredFields();
      
      if (missingFields.length > 0) {
        showMissingFieldsWarning(missingFields);
        return;
      }
      
      await calculateTotal();
    }
    
    function checkRequiredFields() {
      const missing = [];
      
      // 1. Основні параметри
      if (!document.getElementById("wardrobeForm").value) {
        missing.push("1. Форма шафи");
      }
      if (!document.getElementById("measure").value) {
        missing.push("1. Тип замірів");
      }
      if (!document.getElementById("geom").value) {
        missing.push("1. Нестандартна геометрія");
      }
      if (!document.getElementById("attic").value) {
        missing.push("1. Мансардна шафа");
      }
      if (!document.getElementById("installationType").value) {
        missing.push("1. Тип встановлення шафи");
      }
      
      // 2. Матеріали
      const corpus = document.getElementById("corpus").value;
      if (!corpus || parseInt(corpus) <= 0) {
        missing.push("2. Матеріал корпуса (кількість)");
      }
      
      const glassSelect = document.getElementById("glassSelect").value;
      if (!glassSelect) {
        missing.push("2. Скло-дзеркало (вибір)");
      }
      if (glassSelect === "Так") {
        const glassCount = document.getElementById("glassCount").value;
        if (!glassCount || parseInt(glassCount) <= 0) {
          missing.push("2. Скло-дзеркало (кількість)");
        }
      }
      
      const hasFacadeMaterials = document.getElementById("hasFacadeMaterials").value;
      if (!hasFacadeMaterials) {
        missing.push("2. Фасадні матеріали (вибір)");
      }
      if (hasFacadeMaterials === "yes") {
        const facadeMaterials = document.querySelectorAll('[id^="facadeMaterial_"]');
        if (facadeMaterials.length === 0) {
          missing.push("2. Фасадні матеріали (не додано жодного)");
        }
      }
      
      // 3. Корпуса-модулі
      const sections = document.getElementById("sectionsCount").value;
      if (!sections || parseFloat(sections) <= 0) {
        missing.push("3. Довжина шафи м/п");
      }
      
      const facadeTypes = document.querySelectorAll('#facadeTypesList .element-item');
      if (facadeTypes.length === 0) {
        missing.push("3. Типи фасадів (не додано жодного)");
      }
      
      // 4. Додаткові елементи
      const hasAdditionalElements = document.getElementById("hasAdditionalElements").value;
      if (!hasAdditionalElements) {
        missing.push("4. Додаткові елементи (вибір)");
      }
      
      // 5. Функціональна фурнітура
      const furnFields = ["furnDrawers", "furnLifts", "furnAccessories", "furnHangingRods", "furnBarMechanisms"];
      for (let fieldId of furnFields) {
        const field = document.getElementById(fieldId);
        if (!field || field.value === "") {
          const labels = {
            "furnDrawers": "5. Ящики",
            "furnLifts": "5. Підйомні механізми", 
            "furnAccessories": "5. Аксесуари до шафи",
            "furnHangingRods": "5. Штанги для одягу",
            "furnBarMechanisms": "5. Барні механізми"
          };
          missing.push(labels[fieldId]);
        }
      }
      
      // 6. Ручки
      const hasHandles = document.getElementById("hasHandles").value;
      if (!hasHandles) {
        missing.push("6. Ручки (вибір)");
      }
      if (hasHandles === "yes") {
        const handles = document.querySelectorAll('#handlesList .element-item');
        if (handles.length === 0) {
          missing.push("6. Ручки (не додано жодної)");
        }
      }
      
      // 7. Підсвітка
      const hasLighting = document.getElementById("hasLighting").value;
      if (!hasLighting) {
        missing.push("7. Підсвітка (вибір)");
      }
      if (hasLighting === "yes") {
        const lightingItems = document.querySelectorAll('#lightingList .element-item');
        if (lightingItems.length === 0) {
          missing.push("7. Підсвітка (не додано жодного елемента)");
        }
      }
      
      // 8. Вбудована техніка
      const hasAppliances = document.getElementById("hasAppliances").value;
      if (!hasAppliances) {
        missing.push("8. Вбудована техніка (вибір)");
      }
      if (hasAppliances === "yes") {
        const appliances = document.querySelectorAll('#appliancesList .element-item');
        if (appliances.length === 0) {
          missing.push("8. Вбудована техніка (не додано жодного елемента)");
        }
      }
      
      return missing;
    }
    
    function showMissingFieldsWarning(missingFields) {
      let warningText = "Не заповнені наступні поля:\n\n";
      missingFields.forEach((field) => {
        warningText += `${field}\n`;
      });
      
      document.getElementById("warningText").innerText = warningText;
      document.getElementById("warningModal").style.display = "flex";
    }

    function showWarning(text) {
      document.getElementById("warningText").innerText = text;
      document.getElementById("warningModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("warningModal").style.display = "none";
    }
    
    function buildFilename() {
      const project = document.getElementById('projectNum')?.value?.trim() || '';
      const manager = document.getElementById('managerName')?.value?.trim() || '';
      const date = document.getElementById('dateField')?.value?.trim() || new Date().toISOString().split('T')[0];
      
      const parts = [];
      if (project) parts.push(project.replace(/\s+/g, '_'));
      if (manager) parts.push(manager.replace(/\s+/g, '_'));
      parts.push(date);
      
      const base = parts.join('__') || 'kitchen_calc_' + new Date().toISOString().split('T')[0];
      return base + '.vcalc.json';
    }
    
      
      function valInt(id) {
        const el = document.getElementById(id);
        if (!el) return 0;
        const v = parseInt(el.value);
        return isNaN(v) ? 0 : v;
      }
      
      function valLength(id) {
        const el = document.getElementById(id);
        if (!el) return 0;
        const v = parseFloat(el.value);
        return (Number.isFinite(v) && v > 0) ? Math.ceil(v) : 0; // округлення в більшу сторону
      }
      
      function valYes(id) {
        const el = document.getElementById(id);
        return el && (el.value === "Так" || el.value === "так" || el.value === "yes" || el.value === "1");
      }
      
      function addDetail(label, count, tariffId) {
        const t = getSettingValue(tariffId);
        if (!count || !t) return;
        points += count * t;
      }

      // ===== 1. Основні параметри =====
      (function(){
        const form = (document.getElementById("wardrobeForm")?.value || "").trim();
        if (form === "Пряма") addDetail("Форма шафи: Пряма", 1, "p_wardrobe_forma_pryama");
        else if (form === "Г-подібна") addDetail("Форма шафи: Г-подібна", 1, "p_wardrobe_forma_g");
        else if (form === "П-подібна") addDetail("Форма шафи: П-подібна", 1, "p_wardrobe_forma_p");
        else if (form === "G-подібна") addDetail("Форма шафи: G-подібна", 1, "p_wardrobe_forma_g_eng");

        const measure = (document.getElementById("measure")?.value || "").trim();
        if (measure === "Без замірів") {
          addDetail("Заміри: Без замірів", 1, "p_wardrobe_zamir_none");
        } else if (measure === "По замірам 3D") {
          addDetail("Заміри: По замірам 3D", 1, "p_wardrobe_zamir_3d");
        } else if (measure === "По замірам фото-ескіз") {
          addDetail("Заміри: По замірам фото-ескіз", 1, "p_wardrobe_zamir_photo");
        }

        const geomYes = (document.getElementById("geom")?.value || "").trim().toLowerCase() === "так";
        if (geomYes) addDetail("Нестандартна геометрія", 1, "p_wardrobe_geo");

        const atticYes = (document.getElementById("attic")?.value || "").trim().toLowerCase() === "так";
        if (atticYes) addDetail("Мансардна шафа", 1, "p_wardrobe_attic");
      })();

      // ===== 2. Матеріали =====
      (function(){
        const corpusCount = parseInt(document.getElementById("corpus")?.value) || 0;
        if (corpusCount > 0) addDetail("Матеріал корпусу", corpusCount, "p_wardrobe_mat_corpus");

        const glassSel = (document.getElementById("glassSelect")?.value || "").trim().toLowerCase();
        const glassCount = parseInt(document.getElementById("glassCount")?.value) || 0;
        if (glassSel === "так" && glassCount > 0) addDetail("Скло-дзеркало", glassCount, "p_wardrobe_mat_glass");
      })();

      // 2. Матеріали - Фасадні матеріали (нова система)
const hasFacadeMaterials = document.getElementById("hasFacadeMaterials").value;
if (hasFacadeMaterials === "yes") {
  const facadeMaterials = document.querySelectorAll('[id^="facadeMaterial_"]');
  
  const materialMapping = {
    "dsp_mat": "p_wardrobe_facade_dsp_mat",
    "dsp": "p_wardrobe_facade_dsp", 
    "mdf": "p_wardrobe_facade_mdf",
    "paint_straight": "p_wardrobe_facade_paint_straight",
    "paint_milled": "p_wardrobe_facade_paint_milled",
    "veneer_straight": "p_wardrobe_facade_veneer_straight",
    "veneer_milled": "p_wardrobe_facade_veneer_milled",
    "alum_frame": "p_wardrobe_facade_alum_frame",
    "arpa": "p_wardrobe_facade_arpa",
    "fiushin": "p_wardrobe_facade_fiushin",
    "hpl": "p_wardrobe_facade_hpl",
    "rd_individual": "p_wardrobe_facade_rd_individual",
    "mdf_individual": "p_wardrobe_facade_mdf_individual"
  };

  facadeMaterials.forEach((material, index) => {
  const materialType = material.getAttribute('data-material-type');
  const texture = material.getAttribute('data-texture');
  
  // Додаємо поінти за матеріал
  if (materialType && materialMapping[materialType]) {
    addDetail(`Фасадний матеріал ${index + 1}`, 1, materialMapping[materialType]);
  }
  
  // Додаємо поінти за текстуру (тільки якщо вибрано "з текстурою")
    if (texture === "yes") {
      addDetail(`Текстура фасадного матеріалу ${index + 1}`, 1, "p_wardrobe_facade_texture");
    }
});


      // 3. Корпуса-модулі
      addDetail("Довжина шафи м/п", valLength("sectionsCount"), "p_wardrobe_sections");
      
      const facadeType = document.getElementById("facadeType").value;
      if (facadeType === "swing" || facadeType === "sliding") {
        const facadeTypes = document.querySelectorAll('[id^="facadeType_"][id$="_count"]');
        for (let type of facadeTypes) {
          const count = parseInt(type.value) || 0;
          if (count > 0) {
            const typeId = type.id.replace('_count', '');
            const typeDiv = document.getElementById(typeId);
            if (typeDiv) {
              const label = typeDiv.querySelector('label').textContent;
              if (label.includes('Розпашні')) {
                addDetail("Фасади роспашні", count, "p_wardrobe_swing_facades");
              } else if (label.includes('Розсувні')) {
                addDetail("Фасади розсувні", count, "p_wardrobe_furn_sliding_bottom");
              }
            }
          }
        }
      }

      // 4. Додаткові елементи
      const hasAdditionalElements = document.getElementById("hasAdditionalElements").value;
      if (hasAdditionalElements === "yes") {
        const additionalElements = document.querySelectorAll('[id^="additionalElement_"][id$="_count"]');
        for (let element of additionalElements) {
          const count = parseInt(element.value) || 0;
          if (count > 0) {
            const elementId = element.id.replace('_count', '');
            const elementDiv = document.getElementById(elementId);
            if (elementDiv) {
              const label = elementDiv.querySelector('label').textContent.replace(':', '');
              let paramKey = '';
              if (label.includes('горизонтальні')) paramKey = 'p_wardrobe_false_hor';
              else if (label.includes('вертикальні')) paramKey = 'p_wardrobe_false_ver';
              else if (label.includes('R&D') || label.includes('гнутий')) paramKey = 'p_wardrobe_false_rnd';
              else if (label.includes('рамкова')) paramKey = 'p_wardrobe_metal_frame';
              else if (label.includes('обємна')) paramKey = 'p_wardrobe_metal_volume';
              
              if (paramKey) {
                addDetail(label, count, paramKey);
              }
            }
          }
        }
      }

      // 5. Функціональна фурнітура
      addDetail("Ящики",                    valInt("furnDrawers"),      "p_wardrobe_furn_drawers");
      addDetail("Підійомні механізми",      valInt("furnLifts"),        "p_wardrobe_furn_lifts");
      addDetail("Аксесуари до шафи",        valInt("furnAccessories"),  "p_wardrobe_furn_accessories");
      addDetail("Штанги для одягу",         valInt("furnHangingRods"),  "p_wardrobe_furn_hanging_rods");
      addDetail("Барні механізми",          valInt("furnBarMechanisms"), "p_wardrobe_furn_bar_mechanisms");

      // 6. Ручки - поінти тільки за конкретні типи
      if (valYes("hasHandles")) {
        const handlesList = document.querySelectorAll('#handlesList .element-item');
        const handleMapping = {
          "GOLA": "p_wardrobe_handle_gola_low",
          "Торцеві": "p_wardrobe_handle_end",
          "Фрезеровані": "p_wardrobe_handle_milled",
          "Інші, накладні тощо": "p_wardrobe_handle_other"
        };
        
        handlesList.forEach(handle => {
          const label = handle.querySelector('label');
          if (label) {
            const handleName = label.textContent.replace(/^\d+\.\s*Ручка:\s*/, '');
            if (handleMapping[handleName]) {
              addDetail("Ручки: " + handleName, 1, handleMapping[handleName]);
            }
          }
        });
      }

      // 7. Підсвітка
      if (valYes("hasLighting")) {
        const lightingList = document.querySelectorAll('#lightingList .element-item');
        const lightingMapping = {
          "К-сть елементів (деталей) з підсвіткою": "p_wardrobe_light_mod",
          "К-сть пристроїв керування": "p_wardrobe_light_work"
        };
        
        lightingList.forEach(lighting => {
          const label = lighting.querySelector('label');
          const countInput = lighting.querySelector('input[type="number"]');
          if (label && countInput) {
            const lightingName = label.textContent.replace(/^\d+\.\s*/, '').replace(':', '');
            const count = parseInt(countInput.value) || 0;
            if (lightingMapping[lightingName] && count > 0) {
              addDetail("Підсвітка: " + lightingName, count, lightingMapping[lightingName]);
            }
          }
        });
      }

      // 8. Вбудована техніка
      if (valYes("hasAppliances")) {
        const appliancesList = document.querySelectorAll('#appliancesList .element-item');
        const applianceMapping = {
          "tech_hatch": "p_wardrobe_tech_hatch",
          "tech_appliance": "p_wardrobe_tech_appliance"
        };
        
        appliancesList.forEach(appliance => {
          const applianceType = appliance.getAttribute('data-appliance-type');
          const quantity = parseInt(appliance.getAttribute('data-quantity')) || 0;
          const label = appliance.querySelector('label');
          if (label && applianceType && quantity > 0) {
            const applianceName = label.textContent.replace(/^\d+\.\s*/, '').replace(':','');
            const tariffId = applianceMapping[applianceType];
            if (tariffId) {
              addDetail("Техніка: " + applianceName, quantity, tariffId);
            }
          }
        });
      }

      // Вивід - показуємо поінти тільки після успішного розрахунку
      const out = document.getElementById("pointsResult");
      if (out) {
        out.textContent = "Поінти: " + Math.ceil(points);
        out.style.display = "block";
      }
      
      // Показуємо лічільник поінтів і оновлюємо його
      const currentPointsElement = document.getElementById("currentPoints");
      const pointsDisplay = document.getElementById("pointsDisplay");
      
      // Показуємо результат біля кнопки
      const pointsResultElement = document.getElementById("pointsResult");
      const pointsValueElement = document.getElementById("pointsValue");
      
      if (pointsResultElement && pointsValueElement) {
        pointsValueElement.textContent = Math.ceil(points);
        pointsResultElement.style.display = "block";
      }
      
      // Також спробуємо старий лічільник
      if (currentPointsElement && pointsDisplay) {
        currentPointsElement.textContent = points;
        pointsDisplay.style.display = "block";
        pointsDisplay.style.visibility = "visible";
        pointsDisplay.style.opacity = "1";
      }
    }

    function clearForm() {
      document.querySelectorAll("input, select").forEach(el => {
        if (el.id !== "dateField") {  // Не очищуємо дату
          if (el.id !== "dateField") el.value = "";
        }
      });
      document.getElementById("facadeContainer").innerHTML = "";
      document.getElementById("countertopFields").classList.add("hidden");
      document.getElementById("backsplashFields").classList.add("hidden");
      document.getElementById("lightingFields").classList.add("hidden");
      
      // Приховуємо поінти при очищенні
      const out = document.getElementById("pointsResult");
      if (out) out.style.display = "none";
      
      // Приховуємо лічильник поінтів і скидаємо до 0
      const pointsDisplay = document.getElementById("pointsDisplay");
      const currentPointsElement = document.getElementById("currentPoints");
      if (pointsDisplay) pointsDisplay.style.display = "none";
      if (currentPointsElement) currentPointsElement.textContent = "0";
    }

   
    window.onload = function() {
      // Приховуємо поінти при завантаженні
      const out = document.getElementById("pointsResult");
      if (out) out.style.display = "none";
      const hud = document.getElementById("pointsHUD");
      if (hud) hud.style.display = "none";
      
      const dateField = document.getElementById("dateField");
      if (dateField) {
        // Встановлюємо поточну дату
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const formatted = `${day}-${month}-${year}`;
        dateField.value = formatted;
        
        // Блокуємо поле дати назавжди
        dateField.readOnly = true;
        dateField.style.backgroundColor = '#f5f5f5';
        dateField.style.cursor = 'not-allowed';
        dateField.title = 'Дата встановлена автоматично і не може бути змінена';
        
        // Заборона редагування дати користувачем
        dateField.addEventListener('input', function(e) {
          // Відновлюємо правильну дату, якщо користувач спробував змінити
          const today = new Date();
          const day = String(today.getDate()).padStart(2, '0');
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const year = today.getFullYear();
          const formatted = `${day}-${month}-${year}`;
          setTimeout(() => {
            dateField.value = formatted;
          }, 0);
        });
        
        dateField.addEventListener('keydown', function(e) {
          e.preventDefault();
          return false;
        });
        
        dateField.addEventListener('paste', function(e) {
          e.preventDefault();
          return false;
        });
      }
          
      // Оновлюємо поінти після завантаження сторінки
      if (typeof updatePointsDisplay === "function") {
        updatePointsDisplay();
      }
    }
  </script>
<script>


function calculateTotal() {
  
  function getSettingValueLocal(id) {
    // Використовуємо зовнішній файл налаштувань
    if (typeof window.getSettingValue === 'function') {
      return window.getSettingValue(id);
    }
    
    // Fallback - повертаємо стандартне значення
    console.warn('⚠️ Бібліотека налаштувань недоступна, використовую стандартне значення: 1');
    return 1;
  }
  
  function valInt(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    const v = parseInt(el.value);
    return (Number.isFinite(v) && v > 0) ? v : 0; // only positive
  }
  
  function valLength(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    const v = parseFloat(el.value);
    return (Number.isFinite(v) && v > 0) ? Math.ceil(v) : 0; // округлення в більшу сторону
  }
  
  function valYes(id){
    const el=document.getElementById(id);
    if(!el) return false;
    if(el.type==="checkbox") return !!el.checked;
    const v=(el.value||"").toString().trim().toLowerCase();
    return v==="так"||v==="yes"||v==="1"||v==="true";
  }
  function addDetail(label, count, tariffId) {
    if (!count || count <= 0) return;
    const t = getSettingValueLocal(tariffId);
    if (!t || t <= 0) return;
    points += count * t;
  }


  let points = 0;

  
  // ===== 1. Основні параметри =====
  (async function(){
    const form = (document.getElementById("wardrobeForm")?.value || "").trim();
    if (form === "Пряма") await addDetail("Форма шафи: Пряма", 1, "p_wardrobe_forma_pryama");
    else if (form === "Г-подібна") await addDetail("Форма шафи: Г-подібна", 1, "p_wardrobe_forma_g");
    else if (form === "П-подібна") await addDetail("Форма шафи: П-подібна", 1, "p_wardrobe_forma_p");
    else if (form === "G-подібна") await addDetail("Форма шафи: G-подібна", 1, "p_wardrobe_forma_g_eng");

    const measure = (document.getElementById("measure")?.value || "").trim();
    if (measure === "Без замірів") {
      await addDetail("Заміри: Без замірів", 1, "p_wardrobe_zamir_none");
    } else if (measure === "По замірам 3D") {
      await addDetail("Заміри: По замірам 3D", 1, "p_wardrobe_zamir_3d");
    } else if (measure === "По замірам фото-ескіз") {
      await addDetail("Заміри: По замірам фото-ескіз", 1, "p_wardrobe_zamir_photo");
    }

    const geomYes = (document.getElementById("geom")?.value || "").trim().toLowerCase() === "так";
    if (geomYes) await addDetail("Нестандартна геометрія", 1, "p_wardrobe_geo");

    const atticYes = (document.getElementById("attic")?.value || "").trim().toLowerCase() === "так";
    if (atticYes) await addDetail("Мансардна шафа", 1, "p_wardrobe_attic");

    const installationType = (document.getElementById("installationType")?.value || "").trim();
    if (installationType === "Вбудована") {
      await addDetail("Тип встановлення: Вбудована", 1, "p_wardrobe_installation_builtin");
    } else if (installationType === "Окремостояча") {
      await addDetail("Тип встановлення: Окремостояча", 1, "p_wardrobe_installation_standalone");
    } else if (installationType === "Шафа підвісна") {
      await addDetail("Тип встановлення: Шафа підвісна", 1, "p_wardrobe_installation_suspended");
    }
  })();

  // ===== 2. Матеріали =====
  (function(){
    const corpusCount = parseInt(document.getElementById("corpus")?.value) || 0;
        if (corpusCount > 0) addDetail("Матеріал корпусу", corpusCount, "p_wardrobe_mat_corpus");

    const glassSel = (document.getElementById("glassSelect")?.value || "").trim().toLowerCase();
    const glassCount = parseInt(document.getElementById("glassCount")?.value) || 0;
    if (glassSel === "так" && glassCount > 0) addDetail("Скло-дзеркало", glassCount, "p_wardrobe_mat_glass");

    // Фасадні матеріали вже додаються нижче як 'facadeCount' * p_mat_facade.
  })();

  // getSettingValue функція визначена глобально
  function valInt(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    const v = parseInt(el.value);
    return isNaN(v) ? 0 : v;
  }
  
  function valLength(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    const v = parseFloat(el.value);
    return (Number.isFinite(v) && v > 0) ? Math.ceil(v) : 0; // округлення в більшу сторону
  }
  function valYes(id) {
    const el = document.getElementById(id);
    return el && (el.value === "Так" || el.value === "так" || el.value === "yes" || el.value === "1");
  }
  function addDetail(label, count, tariffId) {
    const t = getSettingValue(tariffId);
    if (!count || !t) return;
    points += count * t;
  }

  // 2. Матеріали - Фасадні матеріали (нова система)
  const hasFacadeMaterials = document.getElementById("hasFacadeMaterials").value;
  if (hasFacadeMaterials === "yes") {
    const facadeMaterials = document.querySelectorAll('[id^="facadeMaterial_"]');
    for (let material of facadeMaterials) {
      const label = material.querySelector('label').textContent;
      let paramKey = '';
      if (label.includes('ДСП мат.корпусу')) paramKey = 'p_facade_dsp_mat';
      else if (label.includes('ДСП') && !label.includes('мат.корпусу')) paramKey = 'p_facade_dsp';
      else if (label.includes('МДФ плити')) paramKey = 'p_facade_mdf';
      else if (label.includes('Фарба/плівка "прямі"')) paramKey = 'p_facade_paint_straight';
      else if (label.includes('Фарба/плівка "фрезеровані"')) paramKey = 'p_facade_paint_milled';
      else if (label.includes('Шпоновані "прямі"')) paramKey = 'p_facade_veneer_straight';
      else if (label.includes('Шпоновані "фрезеровані"')) paramKey = 'p_facade_veneer_milled';
      else if (label.includes('Алюм. рамкові')) paramKey = 'p_facade_alum_frame';
      else if (label.includes('ARPA/Fenix')) paramKey = 'p_facade_arpa';
      else if (label.includes('Fiushin')) paramKey = 'p_facade_fiushin';
      else if (label.includes('HPL')) paramKey = 'p_facade_hpl';
      else if (label.includes('R&D фасади індивід.')) paramKey = 'p_facade_rd_individual';
      else if (label.includes('МДФ фасади з індивідуальним фрезеруванням')) paramKey = 'p_facade_mdf_individual';
      
      if (paramKey) {
        addDetail("Фасадний матеріал: " + label, 1, paramKey);
      }
    }
  }


  // 3. Корпуса-модулі
      addDetail("Довжина шафи м/п", valLength("sectionsCount"), "p_wardrobe_sections");
  
  // Нова система типів фасадів
  const facadeTypes = document.querySelectorAll('#facadeTypesList .element-item');
  for (let type of facadeTypes) {
    const countInput = type.querySelector('input[type="number"]');
    const count = countInput ? parseInt(countInput.value) || 0 : 0;
    const facadeType = type.getAttribute('data-facade-type');
    
    if (count > 0 && facadeType) {
      if (facadeType === 'none') {
        // Для "Без фасадів" рахуємо як 1, незалежно від кількості
        addDetail("Без фасадів", 1, "p_wardrobe_facade_none");
      } else if (facadeType === 'swing') {
        addDetail("Фасади роспашні", count, "p_wardrobe_swing_facades");
      } else if (facadeType === 'sliding_bottom') {
        addDetail("Розсувні с-ми (нижньоопорні)", count, "p_wardrobe_furn_sliding_bottom");
      } else if (facadeType === 'sliding_top') {
        addDetail("Розсувні с-ми (верхньопідвісні)", count, "p_wardrobe_furn_sliding_top");
      } else if (facadeType === 'wingline') {
        addDetail("Складна система WingLine", count, "p_wardrobe_furn_wingline");
      } else if (facadeType === 'sliding_doors') {
        addDetail("Системи розсувних дверей (Revego, Hawa, Salice)", count, "p_wardrobe_furn_doors");
      } else if (facadeType === 'slide_m') {
        addDetail("Розсувні с-ми (типу slide М)", count, "p_wardrobe_furn_slide");
      }
    }
  }

  // 4. Додаткові елементи
  const hasAdditionalElements = document.getElementById("hasAdditionalElements").value;
  if (hasAdditionalElements === "yes") {
    const additionalElements = document.querySelectorAll('[id^="additionalElement_"][id$="_count"]');
    for (let element of additionalElements) {
      const count = parseInt(element.value) || 0;
      if (count > 0) {
        const elementId = element.id.replace('_count', '');
        const elementDiv = document.getElementById(elementId);
        if (elementDiv) {
          const label = elementDiv.querySelector('label').textContent.replace(':', '');
          let paramKey = '';
          if (label.includes('горизонтальні')) paramKey = 'p_wardrobe_false_hor';
          else if (label.includes('вертикальні')) paramKey = 'p_wardrobe_false_ver';
          else if (label.includes('R&D') || label.includes('гнутий')) paramKey = 'p_wardrobe_false_rnd';
          else if (label.includes('рамкова')) paramKey = 'p_wardrobe_metal_frame';
          else if (label.includes('обємна')) paramKey = 'p_wardrobe_metal_volume';
          
          if (paramKey) {
            addDetail(label, count, paramKey);
          }
        }
      }
    }
  }

  // 5. Функціональна фурнітура
  addDetail("Ящики",                    valInt("furnDrawers"),      "p_furn_drawers");
  addDetail("Підійомні механізми",      valInt("furnLifts"),        "p_furn_lifts");
  addDetail("Аксесуари до шафи",        valInt("furnAccessories"),  "p_furn_accessories");
  addDetail("Штанги для одягу",         valInt("furnHangingRods"),  "p_furn_hanging_rods");
  addDetail("Барні механізми",          valInt("furnBarMechanisms"), "p_furn_bar_mechanisms");

  // 6. Ручки - поінти тільки за конкретні типи
  if (valYes("hasHandles")) {
    const handlesList = document.querySelectorAll('#handlesList .element-item');
    const handleMapping = {
      "GOLA": "p_handle_gola_low",
      "Торцеві": "p_handle_end",
      "Фрезеровані": "p_handle_milled",
      "Інші, накладні тощо": "p_handle_other"
    };
    
    handlesList.forEach(handle => {
      const label = handle.querySelector('label');
      if (label) {
        const handleName = label.textContent.replace(/^\d+\.\s*Ручка:\s*/, '');
        if (handleMapping[handleName]) {
          addDetail("Ручки: " + handleName, 1, handleMapping[handleName]);
        }
      }
    });
  }

  // 7. Підсвітка
  if (valYes("hasLighting")) {
    const lightingList = document.querySelectorAll('#lightingList .element-item');
    const lightingMapping = {
      "К-сть елементів (деталей) з підсвіткою": "p_wardrobe_light_mod",
      "К-сть пристроїв керування": "p_wardrobe_light_work"
    };
    
    lightingList.forEach(lighting => {
      const label = lighting.querySelector('label');
      const countInput = lighting.querySelector('input[type="number"]');
      if (label && countInput) {
        const lightingName = label.textContent.replace(/^\d+\.\s*/, '').replace(':', '');
        const count = parseInt(countInput.value) || 0;
        if (lightingMapping[lightingName] && count > 0) {
          addDetail("Підсвітка: " + lightingName, count, lightingMapping[lightingName]);
        }
      }
    });
  }

  // 8. Вбудована техніка
  if (valYes("hasAppliances")) {
    const appliancesList = document.querySelectorAll('#appliancesList .element-item');
    const applianceMapping = {
      "tech_hatch": "p_tech_hatch",
      "tech_appliance": "p_tech_appliance"
    };
    
    appliancesList.forEach(appliance => {
      const applianceType = appliance.getAttribute('data-appliance-type');
      const quantity = parseInt(appliance.getAttribute('data-quantity')) || 0;
      const label = appliance.querySelector('label');
      if (label && applianceType && quantity > 0) {
        const applianceName = label.textContent.replace(/^\d+\.\s*/, '').replace(':','');
        const tariffId = applianceMapping[applianceType];
        if (tariffId) {
          addDetail("Техніка: " + applianceName, quantity, tariffId);
        }
      }
    });
  }

  // Вивід - показуємо поінти тільки після успішного розрахунку
  const pointsResultElement = document.getElementById("pointsResult");
  const pointsValueElement = document.getElementById("pointsValue");
  
  if (pointsResultElement && pointsValueElement) {
    pointsValueElement.textContent = Math.ceil(points);
    pointsResultElement.style.display = "block";
  }
  
  return points;
}

// Функції збереження та завантаження
function saveData() {
  try {
    // Збираємо всі дані форми
    const formData = {};
    document.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.id && !el.closest('#inlineSaveControls')) {
        const value = el.type === 'checkbox' || el.type === 'radio' ? el.checked : el.value;
        formData[el.id] = value;
      }
    });
    
    // Додаємо метадані
    const data = {
      meta: {
        kind: 'viyar-wardrobe-calc',
        version: '1.0',
        timestamp: new Date().toISOString(),
        title: 'Калькулятор шафи гардероби'
      },
      values: formData
    };
    
    // Створюємо та завантажуємо файл
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wardrobe-calc-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('✅ Дані збережено!');
  } catch (error) {
    console.error('Помилка збереження:', error);
    alert('❌ Помилка збереження: ' + error.message);
  }
}

function loadData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,.vcalc.json';
  
  input.onchange = function(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(ev) {
      try {
        const data = JSON.parse(ev.target.result);
        if (data && data.values) {
          // Застосовуємо збережені дані
          Object.keys(data.values).forEach(key => {
            const el = document.getElementById(key);
            if (el) {
              if (el.type === 'checkbox' || el.type === 'radio') {
                el.checked = data.values[key];
              } else {
                el.value = data.values[key];
              }
            }
          });
          
          // Оновлюємо поінти
          if (typeof calculate === 'function') {
            calculate();
          }
          
          alert('✅ Дані завантажено!');
        } else {
          alert('❌ Невірний формат файлу');
        }
      } catch (error) {
        console.error('Помилка завантаження:', error);
        alert('❌ Помилка завантаження: ' + error.message);
      }
    };
    reader.readAsText(file);
  };
  
  input.click();
}

// Функція для завантаження PDF
async function downloadPDF() {
  try {
    
    // Перевіряємо, чи завантажилися бібліотеки
    if (typeof window.html2canvas === 'undefined') {
      alert('Помилка: Бібліотека html2canvas не завантажилася. Спробуйте перезавантажити сторінку.');
      return;
    }
    
    if (typeof window.jspdf === 'undefined') {
      alert('Помилка: Бібліотека jsPDF не завантажилася. Спробуйте перезавантажити сторінку.');
      return;
    }
    
    // Показуємо індикатор завантаження
    const button = document.querySelector('button[onclick="downloadPDF()"]');
    const originalText = button.textContent;
    button.textContent = '🔄 Генеруємо PDF...';
    button.disabled = true;
    button.style.opacity = '0.7';
    
    // Імпортуємо html2canvas
    const html2canvas = window.html2canvas;
    const jsPDF = window.jspdf?.jsPDF || window.jspdf;
    
    // Отримуємо елемент для конвертації
    const element = document.querySelector('.wrapper');
    
    if (!element) {
      throw new Error('Елемент .wrapper не знайдено');
    }
    
    // Конвертуємо в canvas
    const canvas = await html2canvas(element, {
      scale: 2, // Вища якість
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff',
      width: element.scrollWidth,
      height: element.scrollHeight
    });
    
    // Створюємо PDF
    const imgData = canvas.toDataURL('image/png');
    
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    // Розраховуємо розміри для A4
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = canvas.width;
    const imgHeight = canvas.height;
    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
    const imgX = (pdfWidth - imgWidth * ratio) / 2;
    const imgY = 0;
    
    // Додаємо зображення до PDF
    pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
    
    // Генеруємо назву файлу
    const projectNum = document.getElementById('projectNum').value || 'Без_номера';
    const productName = document.getElementById('productName').value || 'Шафа_гардероб';
    const date = document.getElementById('dateField').value || new Date().toLocaleDateString('uk-UA');
    const fileName = `Калькулятор_шафи_гардероби_${projectNum}_${productName}_${date}.pdf`;
    
    // Завантажуємо PDF
    pdf.save(fileName);
    
  } catch (error) {
    alert('Помилка при генерації PDF: ' + error.message);
  } finally {
    // Відновлюємо кнопку
    const button = document.querySelector('button[onclick="downloadPDF()"]');
    if (button) {
      button.textContent = originalText;
      button.disabled = false;
      button.style.opacity = '1';
    }
  }
}
</script>
<!-- Результат розрахунку -->
<div id="resultBox" style="background:#f9fafb;border:1px solid #d1d5db;padding:12px;border-radius:8px;margin-top:20px;">
<h3>Результат розрахунку</h3>
<p id="pointsResult" style="font-size:18px;font-weight:bold;color:#1d4ed8;display:none;">Поінти: 0</p>
</div>
</div></div>

</body>
</html>
<script>
// Ініціалізація оновлення поінтів в реальному часі
document.addEventListener("DOMContentLoaded", () => {
  // Додаємо обробники для оновлення поінтів в реальному часі
  if (typeof addRealTimeListeners === "function") {
    addRealTimeListeners();
  }
  
  // Початкове оновлення поінтів
  if (typeof updatePointsDisplay === "function") {
    updatePointsDisplay();
  }
});
</script>

